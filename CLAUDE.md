# CLAUDE.md

## –í–ê–ñ–ù–û
- –° –∫–∞–∂–¥—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–π CLAUDE.md –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ skills –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
  - `/deploy` ‚Äî –¥–µ–ø–ª–æ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º –Ω–∞ Keenetic
  - `/marketplace` ‚Äî –º–æ–¥—É–ª—å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, —ç–∫–æ–Ω–æ–º—å —Ç–æ–∫–µ–Ω—ã
- –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ CLAUDE.md

## –ü—Ä–æ–µ–∫—Ç
- cultvshn-bot ‚Äî Telegram long-polling bot (–ø–æ–¥ Keenetic OS 5+)

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- Runtime: **Node.js 18.20.2** (–±–µ–∑ —Å–±–æ—Ä–∫–∏)
- –Ø–∑—ã–∫: JS + `.d.ts` –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤. `strict: true`, `allowJs: true`
- DB: **Firebase Firestore** (`firebase-admin`)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `.env` —á–µ—Ä–µ–∑ `dotenv`. –°–µ–∫—Ä–µ—Ç—ã –≤ `.gitignore`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
scripts/                            # –°–∫—Ä–∏–ø—Ç—ã –ø–æ –∑–∞–ø—É—Å–∫—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é cultvshn-bot –Ω–∞ Keenetic OS 5+
src/
‚îú‚îÄ‚îÄ entrypoints/                    # –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ poll.js                     # Long polling + –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ poll-daemon.js              # Daemon-supervisor –¥–ª—è poll.js
‚îî‚îÄ‚îÄ shared/                         # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥
    ‚îú‚îÄ‚îÄ config/                     # –ß—Ç–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (dotenv)
    ‚îÇ   ‚îî‚îÄ‚îÄ env.js + env.d.ts
    ‚îú‚îÄ‚îÄ lib/                        # –£—Ç–∏–ª–∏—Ç—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ logger.js + logger.d.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ messages.js + messages.d.ts   # –¢–µ–∫—Å—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ telegram.js + telegram.d.ts   # Telegram Bot API (fetch)
    ‚îÇ   ‚îî‚îÄ‚îÄ firestore.js + firestore.d.ts # Firestore CRUD
    ‚îî‚îÄ‚îÄ marketplace/                # –ú–æ–¥—É–ª—å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ (skill: /marketplace)
        ‚îî‚îÄ‚îÄ extract.js + extract.d.ts    # –ü–∞—Ä—Å–∏–Ω–≥ —Å—Å—ã–ª–æ–∫
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `TG_BOT_API_TOKEN`
- `FIREBASE_SERVICE_ACCOUNT_JSON` (–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π)
–§–∞–π–ª `.env` ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ

## Firestore ‚Äî –∫–æ–ª–ª–µ–∫—Ü–∏–∏
- `chats/{chatId}`: `firstName, lastName?, username?, role ('unverified'|'verified'|'admin'), state?, createdAt, updatedAt`
- `links/{chatId}_{messageId}`: `url, chatId, createdAt, name?, price?, checkedAt?, invalidAt?`

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ poll.js)
- verified/admin + —Å—Å—ã–ª–∫–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ—Ç–≤–µ—Ç ¬´–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!¬ª
- verified/admin + `/list` ‚Üí inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: [–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞] [üóë] –Ω–∞ –∫–∞–∂–¥—É—é —Å—Å—ã–ª–∫—É; callback `view:`/`del:` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ `handleCallbackQuery`
- verified/admin + `/info` ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ-–∑–∞–≥–ª—É—à–∫–∞
- verified/admin (–ø—Ä–æ—á–µ–µ) ‚Üí ¬´–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/list ¬∑ /info¬ª
- unverified ‚Üí ¬´–¢–µ–±—è —Å–∫–æ—Ä–æ –¥–æ–±–∞–≤—è—Ç, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ.¬ª + upsert –≤ chats/{chatId}
- –¢–µ–∫—Å—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî `messages.js`
- –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª—è–µ–º (in-memory Map –ø–æ chatId), –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ
- –õ–æ–≥–∏–∫–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤: `/marketplace`

## poll-daemon (supervisor)
- –ó–∞–ø—É—Å–∫–∞–µ—Ç `poll.js` –∫–∞–∫ child, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–º exit (code ‚â† 0)
- Exponential backoff: 1s ‚Üí 2s ‚Üí 4s ‚Ä¶ cap 60s; —Å–±—Ä–æ—Å –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ
- –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç SIGTERM/SIGINT –¥–æ—á–µ—Ä–Ω–µ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É. –ù–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏ exit 0

## Deploy
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–µ—Ä–≤–∏—Å–æ–º: `/deploy`
