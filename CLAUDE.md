# CLAUDE.md

Инструкции, соглашения и контекст проекта **cultvshn-bot** — Telegram-бот.

## Обзор проекта

Telegram-бот [@cultvshn_bot](https://t.me/cultvshn_bot). Две точки входа: long polling (основная, на Keenetic OS 5) и cron через GitHub Actions (страховка + дополнительная работа).

## Стек технологий

- **Runtime:** Node.js 18 (ограничение Keenetic OS 5)
- **Язык:** TypeScript (последняя версия), полная типизация, `strict: true`
- **Зависимости:** без сторонних пакетов, кроме редких исключений
  - Разрешено: `dotenv` (чтение .env)
  - Любая новая зависимость требует явного обоснования

## Архитектура: Feature-Sliced Design v2.1

Адаптация FSD под backend Telegram-бота. Слои `pages`, `widgets`, `processes` не применяются.

```
src/
├── app/                          # Слой приложения
│   ├── entrypoints/              # Точки входа
│   │   ├── poll.ts               # Long polling (Keenetic OS 5)
│   │   └── cron.ts               # GitHub Actions cron (каждые 30 мин)
│   └── config/                   # Конфигурация приложения
│
├── features/                     # Фичи (пользовательские сценарии)
│   ├── greeting/                 # Приветствие: ФИО + chat id
│   └── chat-cleanup/             # Очистка окна чата
│
├── entities/                     # Доменные сущности
│   ├── user/                     # Пользователь
│   └── message/                  # Сообщение
│
└── shared/                       # Переиспользуемый код
    ├── api/                      # Клиент Telegram Bot API (fetch)
    ├── config/                   # Чтение переменных окружения (dotenv)
    ├── lib/                      # Утилиты
    └── types/                    # Общие типы
```

### Правила FSD

- Зависимости только сверху вниз: `app → features → entities → shared`
- Обратные зависимости запрещены (shared не импортирует из features)
- Каждый слайс экспортирует public API через `index.ts`
- Внутренности слайса недоступны снаружи — импорт только из `index.ts`

## Переменные окружения

Файл `.env` в корне проекта, читается через `dotenv`:

| Переменная        | Описание                  |
| ----------------- | ------------------------- |
| `TG_BOT_API_TOKEN` | Токен Telegram-бота       |
| `TG_BOT_ADMIN`     | Chat ID админского чата   |

**Важно:** `.env` в `.gitignore`, секреты никогда не попадают в репозиторий.

## Точки входа

### 1. Long polling (`app/entrypoints/poll.ts`)

- Запускается на Keenetic OS 5
- Опрашивает `https://api.telegram.org/bot${TG_BOT_API_TOKEN}/getUpdates`
- При получении сообщения: приветствует пользователя, выводит ФИО и chat id
- Собирается в единый файл `poll.mjs` (ESM)

### 2. Cron (`app/entrypoints/cron.ts`)

- Запускается через GitHub Actions каждые 30 минут
- Страховка: выполняет ту же работу, что и poll (приветствие)
- Дополнительно: сложная работа (пока заглушка)

## Поведение чата

Окно чата должно оставаться чистым:

1. **Перед отправкой** нового сообщения бота — удалить предыдущее сообщение бота
2. **После получения** сообщения пользователя — немедленно удалить его

## Релизы

- Каждый push в `main` создаёт новый релиз
- Артефакты релиза:
  - `https://github.com/Leonhelm/cultvshn/releases/latest/download/poll.mjs` — точка входа long polling
  - `https://github.com/Leonhelm/cultvshn/releases/latest/download/poll.mjs.sha256` — контрольная сумма
- Предыдущие релизы автоматически удаляются

## Логирование

- Логируем основные действия: запуск, получение апдейтов, отправку/удаление сообщений, ошибки
- **Запрещено** логировать: токен бота, содержимое .env, полные ответы API с токеном
- Маскируем секреты: показываем только последние 4 символа токена (`***abcd`)

## Соглашения по коду

- Именование файлов: `kebab-case.ts`
- Именование типов/интерфейсов: `PascalCase`
- Именование переменных/функций: `camelCase`
- Именование констант окружения: `UPPER_SNAKE_CASE`
- Каждый слайс FSD содержит `index.ts` — public API слайса
- Не импортировать из внутренностей слайса напрямую, только через `index.ts`
- Используем нативный `fetch` (доступен в Node.js 18)
- `async/await` вместо колбэков и `.then()`
- Явные типы возвращаемых значений у публичных функций

## Команды

```bash
npm run build         # Сборка проекта
npm run start:poll    # Запуск long polling
npm run start:cron    # Запуск cron задачи
npm run typecheck     # Проверка типов (tsc --noEmit)
```
